<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link 
      rel="icon" 
      type="image/png" 
      href="https://uploads.onecompiler.io/438cc35sk/43t6k2xht/Copilot_20250724_112130_1_-removebg-preview.png" 
      id="favicon"
    />
    <title>CG</title>
    <style>
      html,
        body {
        overflow-x: hidden;
        overflow-y: transparent; 
        height: 100%;
        margin: 0;
        font-family: system-ui, Segoe UI, Roboto, Arial;
        overflow-x: hidden;
        overflow-y: visible;
      }
      #content {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }
      .centerWrap {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="content" class="centerWrap">
      <iframe id="appFrame" title="app-frame"></iframe>
    </div>

    <script>
const params = new URLSearchParams(location.search);
const LOADING_PAGE = params.get("loading") || "loding.html";
const LOGIN_PAGE = params.get("login") || "./frame/homepage.html";
const HOME_PAGE = params.get("home") || "./frame/homepage.html";

const frame = document.getElementById("appFrame");

// ফ্যাভিকন URL
const LIGHT_FAVICON = "https://uploads.onecompiler.io/438cc35sk/43fcju7j3/th-removebg-preview__3_-removebg-preview%20(1).png";
const DARK_FAVICON = "https://cdn-icons-png.flaticon.com/512/581/581601.png";

function normalize(u) {
  try {
    return new URL(u, location.href).href;
  } catch (e) {
    return String(u);
  }
}
const N_LOADING = normalize(LOADING_PAGE);
const N_LOGIN = normalize(LOGIN_PAGE);
const N_HOME = normalize(HOME_PAGE);

// URL প্যারামিটার পড়া
const urlParams = new URLSearchParams(window.location.search);

// কন্ট্রোল প্যারামিটারগুলির তালিকা (যেগুলো হোমপেজে পাঠানো হবে না)
const CONTROL_PARAMS = ['theme', 'loading_skip', 'login_skip', 'loading', 'login', 'home'];

// হোমপেজের জন্য ফিল্টার করা প্যারামিটারস
function getHomePageParams() {
  const filteredParams = new URLSearchParams();
  
  for (const [key, value] of urlParams.entries()) {
    // শুধুমাত্র কন্ট্রোল প্যারামিটার বাদে বাকিগুলো যোগ করুন
    if (!CONTROL_PARAMS.includes(key)) {
      filteredParams.append(key, value);
    }
  }
  
  return filteredParams.toString();
}

// হোমপেজ URL তৈরি করুন (প্যারামিটারসহ)
function getHomePageWithParams() {
  const baseUrl = HOME_PAGE;
  const paramsString = getHomePageParams();
  
  if (paramsString) {
    // চেক করুন যদি BASE URL-এ ইতিমধ্যে প্যারামিটার থাকে
    const separator = baseUrl.includes('?') ? '&' : '?';
    return `${baseUrl}${separator}${paramsString}`;
  }
  
  return baseUrl;
}

// থিম প্যারামিটার প্রসেসিং
function processThemeParam() {
  const themeParam = urlParams.get('theme');
  if (!themeParam) return;
  
  let theme = 'system'; // ডিফল্ট
  
  if (themeParam === 'dark' || themeParam === '2') {
    theme = 'dark';
  } else if (themeParam === 'light' || themeParam === '1') {
    theme = 'light';
  } else if (themeParam === 'system' || themeParam === '3') {
    theme = 'system';
  }
  
  localStorage.setItem('theme', theme);
  return theme;
}

// লোডিং স্কিপ চেক
function shouldSkipLoading() {
  const loadingSkip = urlParams.get('loading_skip');
  return loadingSkip === 'true' || loadingSkip === '1' || loadingSkip === 'yes';
}

// লগইন স্কিপ চেক
function shouldSkipLogin() {
  const loginSkip = urlParams.get('login_skip');
  return loginSkip === 'true' || loginSkip === '1' || loginSkip === 'yes';
}

// লোডিং পেজ স্কিপ লজিক
function handlePageLoading() {
  const loadingSkipped = shouldSkipLoading();
  const loginSkipped = shouldSkipLogin();
  const loggedIn = localStorage.getItem("loggedIn") === "1";
  
  if (loadingSkipped) {
    if (loggedIn) {
      goHome();
    } else if (loginSkipped) {
      goHome(); // লগইনও স্কিপ, সরাসরি হোমে
    } else {
      goLogin();
    }
  } else {
    // লোডিং পেজ দেখানো
    setTimeout(() => (frame.src = LOADING_PAGE), 10);
  }
}

function goHome() {
  const homeUrl = getHomePageWithParams();
  frame.src = homeUrl;
}

function goLogin() {
  // লগইন পেজের জন্যও প্যারামিটার পাঠানো যেতে পারে (ঐচ্ছিক)
  const loginUrl = LOGIN_PAGE;
  frame.src = loginUrl;
}

// ফ্যাভিকন আপডেট ফাংশন
function updateFavicon(theme) {
  const favicon = document.getElementById('favicon');
  if (!favicon) return;
  
  let finalTheme = theme;
  
  // থিম 'system' হলে সিস্টেম থিম চেক করুন
  if (theme === 'system') {
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      finalTheme = 'dark';
    } else {
      finalTheme = 'light';
    }
  }
  
  // ফ্যাভিকন সেট করুন
  if (finalTheme === 'dark') {
    favicon.href = DARK_FAVICON;
  } else {
    favicon.href = LIGHT_FAVICON;
  }
  
  // localStorage-এ সেভ করুন
  localStorage.setItem('theme', theme);
}

// থিম সেটআপ
function setupTheme() {
  // URL থেকে থিম পড়ুন
  const urlTheme = processThemeParam();
  let savedTheme = localStorage.getItem('theme');
  
  // URL থিম প্রাধান্য পায়
  if (urlTheme) {
    savedTheme = urlTheme;
  }
  
  // থিম আপডেট করুন
  if (savedTheme) {
    updateFavicon(savedTheme);
  }
  
  // সিস্টেম থিম পরিবর্তন শুনুন (যদি থিম 'system' হয়)
  const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  
  function handleThemeChange(e) {
    const currentTheme = localStorage.getItem('theme');
    if (currentTheme === 'system') {
      updateFavicon('system');
    }
  }
  
  darkModeMediaQuery.addEventListener('change', handleThemeChange);
}

// 获取用户IP
async function getUserIP() {
  try {
    const response = await fetch("https://api.ipify.org?format=json");
    const data = await response.json();
    return data.ip;
  } catch (error) {
    console.error("获取IP失败:", error);
    return null;
  }
}

// 检查Google Sheets中的用户数据
async function checkUserInSheet(userIP) {
  try {
    const scriptURL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
    const response = await fetch(`${scriptURL}?action=checkUser&ip=${userIP}`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("检查用户失败:", error);
    return null;
  }
}

// 保存用户数据到localStorage
function saveUserData(userData) {
  localStorage.setItem("userData", JSON.stringify(userData));
  localStorage.setItem("loggedIn", "1");
  localStorage.setItem("user", userData.userName);
}

// iFrame থেকে মেসেজ গ্রহণ
window.addEventListener("message", (ev) => {
  if (ev.source !== frame.contentWindow) return;
  const msg = ev.data;
  if (!msg || typeof msg !== "object") return;
  
  if (msg.type === "login") {
    localStorage.setItem("loggedIn", "1");
    if (msg.user) localStorage.setItem("user", msg.user);
    if (msg.theme) {
      localStorage.setItem('theme', msg.theme);
      updateFavicon(msg.theme);
    }
    goHome();
  } else if (msg.type === "logout") {
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("user");
    localStorage.removeItem("userData");
    goLogin();
  } else if (msg.type === "themeChange") {
    if (msg.theme === 'dark' || msg.theme === 'light' || msg.theme === 'system') {
      updateFavicon(msg.theme);
    }
  } else if (msg.type === 'navigate') {
    // iFrame থেকে নেভিগেশন রিকোয়েস্ট হ্যান্ডল করুন
    if (msg.url) {
      frame.src = msg.url;
    }
  }
});

// storage events fire in other windows when localStorage is changed
window.addEventListener("storage", (ev) => {
  if (ev.key !== "loggedIn") return;
  if (ev.newValue === "1") goHome();
  else goLogin();
});

// fallback polling
let pollTimer = null;
function startPolling() {
  if (pollTimer) return;
  pollTimer = setInterval(() => {
    const logged = localStorage.getItem("loggedIn") === "1";
    const current = normalize(frame.src);
    const homeUrl = getHomePageWithParams();
    const normalizedHome = normalize(homeUrl);
    
    if (logged && current !== normalizedHome) {
      goHome();
    }
    if (!logged && current !== N_LOGIN && current !== N_LOADING) {
      goLogin();
    }
  }, 2000);
}

// 检查用户登录状态并处理
async function checkUserStatus() {
  const loggedIn = localStorage.getItem("loggedIn") === "1";
  const loginSkipped = shouldSkipLogin();
  
  // লগইন স্কিপ করা হলে সরাসরি হোমে যান
  if (loginSkipped) {
    saveUserData({
      userName: 'guest',
      ip: await getUserIP()
    });
    goHome();
    startPolling();
    return;
  }
  
  if (loggedIn) {
    goHome();
    startPolling();
    return;
  }

  // 获取用户IP并检查
  const userIP = await getUserIP();
  if (userIP) {
    const userData = await checkUserInSheet(userIP);
    if (userData) {
      saveUserData(userData);
      goHome();
    } else {
      goLogin();
    }
  } else {
    goLogin();
  }
  startPolling();
}

// 检测用户是否使用了广告拦截器，并将结果存储到localStorage
function detectAdBlock(callback) {
  let isBlocked = false;
  let checkDone = 0;

  // 检查1：adsbox元素
  let testAd = document.createElement("div");
  testAd.innerHTML = "&nbsp;";
  testAd.className = "adsbox";
  testAd.style.display = "block";
  testAd.style.position = "absolute";
  testAd.style.left = "-9999px";
  document.body.appendChild(testAd);

  setTimeout(function () {
    if (testAd.offsetHeight === 0 || testAd.offsetParent === null) {
      isBlocked = true;
    }
    testAd.remove();
    done();
  }, 100);

  // 检查2：block adsbygoogle script
  let script = document.createElement("script");
  script.type = "text/javascript";
  script.onerror = function () {
    isBlocked = true;
    done();
  };
  script.onload = function () {
    done();
  };
  script.src = "https://pagead2.googlesygoogle.com/pagead/js/adsbygoogle.js";
  document.body.appendChild(script);

  function done() {
    checkDone++;
    if (checkDone === 2) {
      localStorage.setItem("adblocker", isBlocked ? "1" : "0");
      callback(isBlocked);
    }
  }
}

// পেজ লোড ইভেন্ট
window.addEventListener("load", function () {
  // URL প্যারামিটার প্রসেসিং
  processThemeParam();
  
  // থিম সেটআপ
  setupTheme();
  
  // লোডিং হ্যান্ডলিং
  handlePageLoading();
  
  // ইউজার স্ট্যাটাস চেক
  checkUserStatus();
  
  // 页面加载时检测广告拦截器
  detectAdBlock(function (isBlocked) {
    console.log("广告拦截器检测:", isBlocked ? "未启用" : "已启用");
  });
});

// 定期重新检测广告拦截器
setInterval(function () {
  detectAdBlock(function (isBlocked) {
    const currentStatus = localStorage.getItem("adblocker");
    if (currentStatus !== (isBlocked ? "1" : "0")) {
      localStorage.setItem("adblocker", isBlocked ? "1" : "0");
    }
  });
}, 300000); // 每5分钟检测一次

// iFrame থিম পর্যবেক্ষক
function observeIframeTheme() {
  setInterval(() => {
    try {
      const iframeDoc = frame.contentDocument || frame.contentWindow.document;
      const themeAttr = iframeDoc.documentElement.getAttribute('data-theme') || 
                       iframeDoc.body.getAttribute('data-theme') ||
                       iframeDoc.documentElement.getAttribute('theme');
      
      if (themeAttr === 'dark') {
        updateFavicon('dark');
      } else if (themeAttr === 'light') {
        updateFavicon('light');
      }
    } catch (e) {
      // Cross-origin error
    }
  }, 1000);
}

// iFrame লোড ইভেন্ট
frame.addEventListener('load', () => {
  setTimeout(observeIframeTheme, 2000);
  
  // iFrame লোড হওয়ার পর, URL প্যারামিটার যোগ করুন (যদি প্রয়োজন হয়)
  try {
    const iframeUrl = new URL(frame.src);
    const currentIframeParams = new URLSearchParams(iframeUrl.search);
    const homeParams = getHomePageParams();
    
    // যদি iFrame-এ প্যারামিটার না থাকে, কিন্তু আমাদের কাছে প্যারামিটার থাকে
    if (homeParams && currentIframeParams.toString() === '') {
      const newIframeUrl = iframeUrl.origin + iframeUrl.pathname + '?' + homeParams;
      frame.src = newIframeUrl;
    }
  } catch (e) {
    console.log("Cannot modify iframe URL:", e);
  }
});

// URL প্যারামিটার ডিবাগিং
console.log("URL Parameters:", Object.fromEntries(urlParams.entries()));
console.log("Loading Skip:", shouldSkipLoading());
console.log("Login Skip:", shouldSkipLogin());
console.log("Home Page Params:", getHomePageParams());
console.log("Home Page URL:", getHomePageWithParams());
    </script>
  </body>
</html>
